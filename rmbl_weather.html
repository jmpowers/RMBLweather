<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />


<meta name="author" content="John Powers" />

<meta name="date" content="2021-06-10" />

<title>RMBL Weather Data</title>

<script src="libs/header-attrs-2.8/header-attrs.js"></script>
<script src="libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="libs/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="libs/jqueryui-1.11.4/jquery-ui.min.js"></script>
<link href="libs/tocify-1.9.1/jquery.tocify.css" rel="stylesheet" />
<script src="libs/tocify-1.9.1/jquery.tocify.js"></script>
<script src="libs/navigation-1.1/tabsets.js"></script>
<script src="libs/navigation-1.1/codefolding.js"></script>
<link href="libs/highlightjs-9.12.0/default.css" rel="stylesheet" />
<script src="libs/highlightjs-9.12.0/highlight.js"></script>
<script src="libs/kePrint-0.0.1/kePrint.js"></script>
<link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>








<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
pre code {
  padding: 0;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>



<style type="text/css">

#TOC {
  margin: 25px 0px 20px 0px;
}
@media (max-width: 768px) {
#TOC {
  position: relative;
  width: 100%;
}
}

@media print {
.toc-content {
  /* see https://github.com/w3c/csswg-drafts/issues/4434 */
  float: right;
}
}

.toc-content {
  padding-left: 30px;
  padding-right: 40px;
}

div.main-container {
  max-width: 1200px;
}

div.tocify {
  width: 20%;
  max-width: 260px;
  max-height: 85%;
}

@media (min-width: 768px) and (max-width: 991px) {
  div.tocify {
    width: 25%;
  }
}

@media (max-width: 767px) {
  div.tocify {
    width: 100%;
    max-width: none;
  }
}

.tocify ul, .tocify li {
  line-height: 20px;
}

.tocify-subheader .tocify-item {
  font-size: 0.90em;
}

.tocify .list-group-item {
  border-radius: 0px;
}


</style>



</head>

<body>


<div class="container-fluid main-container">


<!-- setup 3col/9col grid for toc_float and main content  -->
<div class="row">
<div class="col-xs-12 col-sm-4 col-md-3">
<div id="TOC" class="tocify">
</div>
</div>

<div class="toc-content col-xs-12 col-sm-8 col-md-9">




<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>



<h1 class="title toc-ignore">RMBL Weather Data</h1>
<h4 class="author"><a href="http://sites.uci.edu/powers/">John Powers</a></h4>
<h4 class="date">2021-06-10</h4>

</div>


<style type="text/css">
.main-container { max-width: 1000px; margin-left: 0; margin-right: auto; }
img{ max-width:200%; height: auto; }
td, th { padding : 6px }
</style>
<div id="purpose" class="section level1">
<h1>Purpose</h1>
<p>Compile weather records near the Rocky Mountain Biological Laboratory in Gothic, CO and analyze long-term trends in precipitation and temperature.</p>
<pre class="r"><code>library(tidyverse)
library(lubridate)
library(viridis)
library(RColorBrewer)
library(GGally)
library(ggpmisc)
library(knitr)
library(kableExtra)
knitr::opts_chunk$set(comment=&quot;&quot;, cache=T, warning = F, message = F, fig.path = &quot;images_weather/&quot;)

maxfield_coords &lt;- data.frame(id = &quot;maxfield&quot;, name=&quot;MaxfieldMdw&quot;, latitude = 38.9495, longitude = -106.9908)</code></pre>
</div>
<div id="datasets" class="section level1">
<h1>Datasets</h1>
<div id="wrcc" class="section level2">
<h2>WRCC</h2>
<p>Weather data from <a href="https://wrcc.dri.edu/rmbl/">7 RMBL stations</a></p>
<ul>
<li>Provided by the Western Regional Climate Center, the Desert Research Institute, and the Rocky Mountain Biological Laboratory</li>
<li>Raw data in metric units (cleaned “FPA” data unavailable) - lots of cleanup needed, no interspersed missing values, so may not have been quality checked at all.</li>
<li><a href="https://wrcc.dri.edu/cgi-bin/rawMAIN.pl?corbil">Downloaded</a> as xls that is actually a tsv, and added quotes around each text cell, and gzipped</li>
<li>Columns renamed according to <a href="data/WRCC/weather_wrcc_metadata.csv">metadata</a></li>
<li><a href="https://wrcc.dri.edu/cgi-bin/wea_listex.pl?flags">Flags</a> on each column indicate 0 = raw data, (M)issing data, (E)stimated data, (N)on-measuring time interval</li>
<li>Data for billy’s station runs 2009 - present (valid precip data starts 2015-07-01, temperature starts 2015-10-01), other stations run 2009 - 2016 and lack precip but have soil moisture</li>
<li>Data are provided at 10-min intervals, so took the mean (or sum for precip) to aggregate hourly and then daily results</li>
<li>Then removed some precipitation entries much greater than 50 mm/day that were interspersed with valid data</li>
<li><a href="data/WRCC/daily_WRCC.rda">Daily summary RData file</a></li>
</ul>
<pre class="r"><code>wrcc_metadata_noflags &lt;- read_tsv(&quot;data/WRCC/weather_wrcc_metadata.tsv&quot;) %&gt;% mutate(index = row_number(), flag=F)
wrcc_metadata &lt;- bind_rows(wrcc_metadata_noflags, wrcc_metadata_noflags %&gt;% select(name_metric, col_type, index) %&gt;% 
                             filter(! name_metric %in% c(&quot;date&quot;,&quot;time&quot;)) %&gt;% 
  mutate(name_metric=paste0(&quot;flag_&quot;,name_metric), col_type=&quot;f&quot;,flag=T)) %&gt;% arrange(index) %&gt;% fill(id)

#the chunk below loads the WRCC data (slow)
load(&quot;data/WRCC/daily_WRCC.rda&quot;)</code></pre>
<pre class="r"><code>get_WRCC_id &lt;- function(filename) toupper(str_match(filename, &quot;wrcc_([a-z]+)&quot;)[,2])
tenmin_WRCC &lt;- list.files(&quot;data/WRCC/&quot;, &quot;.tsv.gz&quot;, full.names=T) %&gt;% set_names(get_WRCC_id(.)) %&gt;% 
  map_dfr( ~ read_tsv(.x, skip = 4, na=c(&quot;&quot;,&quot;M&quot;), col_types=paste0(filter(wrcc_metadata, id==get_WRCC_id(.x))$col_type, collapse=&quot;&quot;),
                      col_names=filter(wrcc_metadata, id==get_WRCC_id(.x))$name_metric), .id=&quot;id&quot;) 

#this comment says to &quot;take the mean of the precip rate per hour that is reported every 10 min&quot;, but the code sums it and that matches well on the monthly scale with other stations
hourly_WRCC &lt;- tenmin_WRCC %&gt;% mutate(hour=hour(time)) %&gt;% group_by(id, date, hour) %&gt;% 
  summarize(precip_mm = sum(precip_mm), across(where(is.numeric), mean)) 

get_daily_WRCC &lt;- function(grouped_hourly_data) {
  daily &lt;- grouped_hourly_data %&gt;% group_by(id, .add=T) %&gt;% 
  summarize(precip_mm = sum(precip_mm), #sum the hourly precip rates over each 24 hrs 
            max_av_temp_air_C = max(av_temp_air_C), min_av_temp_air_C = min(av_temp_air_C),
            across(where(is.numeric), mean)) %&gt;% 
  mutate(year=factor(year(date)), julian=yday(date),
         precip_mm = ifelse(precip_mm&gt;50 | precip_mm &lt; 0, NA, precip_mm)) #cut nonsense precip values
}
daily_WRCC &lt;- hourly_WRCC %&gt;% group_by(date) %&gt;% get_daily_WRCC()
daily_WRCC_7am &lt;-  hourly_WRCC %&gt;% filter(id %in% c(&quot;CORBIL&quot;, &quot;CORKET&quot;)) %&gt;% 
  group_by(date = case_when(hour &lt;  7 ~ date - days(1), hour &gt;= 7 ~ date)) %&gt;% get_daily_WRCC() %&gt;% 
  select(id, date, year, julian, precip_mm)

save(daily_WRCC, daily_WRCC_7am, file=&quot;data/WRCC/daily_WRCC.rda&quot;)</code></pre>
</div>
<div id="ess-dive" class="section level2">
<h2>ESS-DIVE</h2>
<p>Weather data from the Gold Link Wunderground station in Mt. Crested Butte</p>
<ul>
<li>Data are QAQC’d, gap-filled, and summarized hourly or daily.</li>
<li><a href="data/Wunderground/KComCret_metadata.txt">Metadata</a> and <a href="data/Wunderground/Gap_filled_meteorological_data_2011_2020_and.xml">abstract</a></li>
<li>“This dataset is a gap-filled meteorological dataset (years 2011-2020) that includes modeled potential evapotranspiration from a station near the pumphouse on the East River (KCOMTCRE2 WeatherUnderground) near the top of the ridge at the Pumphouse PLM wells. These datasets are useful as model inputs. The <a href="https://www.wunderground.com/dashboard/pws/KCOMTCRE2/table/2020-12-7/2020-12-7/daily">KOMTCRE2 station</a> is located on Mt. Crested Butte in Colorado. The purpose of this dataset is to use as input to hydrological and flow-reactive transport models as meteorological forcing. One attached file includes metadata files with definitions for all variables and units. Subsequent files include the same time series dataset, but aggregated and gap-filled at different time-stamp intervals. These include 5 minute time-series, 15 minute time-series, 30 minute time-series, 1 hour time-series, daily time-series, and hourly and daily modeled evapotranspiration.”</li>
<li>Michelle Newcomer and David Brian Rogers. 2020. Gap-filled meteorological data (2011-2020) and modeled potential evapotranspiration data from the KCOMTCRE2 WeatherUnderground weather station, from the East River Watershed, Colorado. ESS-DIVE: Deep Insight for Earth Science Data. <a href="https://doi.org/10.15485/1734790">doi:10.15485/1734790</a>, version: ess-dive-ce2fd798f9d81f5-20201210T030125380.</li>
<li>The plot compares the daily precip calculatedd from summing the hourly precipitation rates (in mm/min), or taking the maximum daily accumulated precip. These two numbers should be the same but sometimes differ at midnight (PrecipAccum is sometimes nonzero at midnight), and sometimes when the PrecipRate does not bump up the PrecipAccum. Discrepancy might an artifact of the QA/QC applied by the authors.</li>
</ul>
<pre class="r"><code>hourly_KCOMTCRE2 &lt;- read_csv(&quot;data/Wunderground/2011_2020_KComCret_60min_Measured_QAQC.csv&quot;, guess_max = 3000)
daily_KCOMTCRE2 &lt;- read_csv(&quot;data/Wunderground/2011_2020_KComCret_1day_ETModeled.csv&quot;)

daily_KCOMTCRE2_7am &lt;- hourly_KCOMTCRE2 %&gt;% 
  group_by(date = case_when(hr &lt;  7 ~ date - days(1), hr &gt;= 7 ~ date)) %&gt;% 
  summarize(Precip = sum(PrecipRate)*60) #units are mm/min

daily_KCOMTCRE2_raw &lt;- hourly_KCOMTCRE2 %&gt;% group_by(date) %&gt;% 
  summarize(Sum_PrecipRate = sum(PrecipRate)*60, Max_PrecipAccum = max(PrecipAccum)) 
ggplot(daily_KCOMTCRE2_raw) + geom_point(aes(x=Max_PrecipAccum, y=Sum_PrecipRate)) + coord_cartesian(ylim=c(0,50))</code></pre>
<p><img src="images_weather/Wunderground-1.png" width="672" /></p>
<pre class="r"><code>#hourly_KCOMTCRE2 %&gt;% filter(date %in% (daily_KCOMTCRE2_raw %&gt;% filter(abs(Max_PrecipAccum - Sum_PrecipRate &gt; 0.01)) %&gt;% #pull(date))) %&gt;% View</code></pre>
</div>
<div id="epa-castnet" class="section level2">
<h2>EPA CASTNET</h2>
<p>Weather data from the RMBL Research Meadow</p>
<ul>
<li>EPA CASTNET program, station ID <a href="https://www3.epa.gov/castnet/site_pages/GTH161.html">GTH161</a></li>
<li>Also collects air quality data - ozone and air filters - not yet included here</li>
<li>Starts in 1989 but precipitation data is missing after 2011-12-31 - suspiciously at the end of the year</li>
<li>The <a href="https://www.yakimacounty.us/DocumentCenter/View/13593/EPA2015-castnet-factsheet">CASTNET 2015 Factsheet</a> says “In 2010, meteorological measurements were discontinued at most EPA-sponsored CASTNET sites due to changing priorities, which evolved based on input from policymakers and the research community. As a result, EPA developed a method to substitute historical average deposition velocities for missing MLM simulations (Bowker et al., 2011).” This is echoed in the <a href="https://www3.epa.gov/castnet/docs/annual_report_2010_v2.pdf">2010</a> and <a href="https://www3.epa.gov/castnet/docs/annual_report_2011.pdf">2011</a> annual reports.</li>
<li>Temperature and air quality records continue to present</li>
<li><a href="https://www.uvm.edu/femc/data/archive/project/clean-air-status-trend-network-castnet/dataset/clean-air-status-trend-network-castnet/eml">Metadata</a></li>
<li>Provided hourly, so summarized daily, either propagating missing values or ignoring them (see code)</li>
<li>The plot and table show the number of missing hourly values per day</li>
</ul>
<pre class="r"><code>hourly_GTH161 &lt;- read_csv(&quot;data/EPA_CASTNET/CASTNET_GTH161_Meteorological_Hourly.csv.gz&quot;, 
                          col_types=cols(DATE_TIME=col_datetime(&quot;%m/%d/%Y %H:%M:%S&quot;), QA_CODE=col_character()))

# Tally and plot missing hourly values
hourly_GTH161_missing &lt;- hourly_GTH161 %&gt;% filter(DATE_TIME &lt; ymd(&quot;2012-01-01&quot;)) %&gt;% 
  group_by(date=date(DATE_TIME)) %&gt;% summarize(missing_precip_hrs = sum(is.na(PRECIPITATION)))
ggplot(hourly_GTH161_missing, aes(x=date, y=missing_precip_hrs)) + geom_point() + 
  geom_text(data = hourly_GTH161_missing %&gt;% count(missing_precip_hrs), aes(x=ymd(&quot;1988-01-01&quot;), label=n))</code></pre>
<p><img src="images_weather/EPA_CASTNET-1.png" width="672" /></p>
<pre class="r"><code># daily_GTH161 is used for daily_all, but 
# this keeps precip sums when there is missing hourly values
# an entire day missing gets precip = 0 and temperature = NaN
daily_GTH161 &lt;- hourly_GTH161 %&gt;% mutate(date = date(DATE_TIME)) %&gt;% filter(year(date) &lt; 2012) %&gt;% group_by(date) %&gt;% 
  summarize(TEMPERATURE=mean(TEMPERATURE, na.rm=T), PRECIPITATION = sum(PRECIPITATION, na.rm=T)) 

# daily_GTH161_NA propagates any missing hourly values up to the day.
daily_GTH161_NA &lt;- hourly_GTH161 %&gt;% arrange(DATE_TIME) %&gt;% group_by(date = date(DATE_TIME)) %&gt;% 
    summarize(tavg_C=mean(TEMPERATURE), tmax_C=max(TEMPERATURE), tmin_C=min(TEMPERATURE), 
              prcp_mm = sum(PRECIPITATION), across(where(is.numeric), mean)) 
# Could be customized to accept a few missing hours with maxNA:
#summarizeNA &lt;- function(x, fun, maxNA = 0) {
#  ifelse(sum(is.na(x)) &lt;= maxNA, fun(x, na.rm=T), NA)
#}              
              
# daily_GTH161_NA_7am counts precipitation occurring BEFORE 7 am as the previous day, to  
# line up with CoCoRaHs datasets that I shifted one day back
daily_GTH161_NA_7am &lt;- hourly_GTH161 %&gt;% arrange(DATE_TIME) %&gt;% 
  group_by(date = case_when(hour(DATE_TIME) &lt;  7 ~ date(DATE_TIME) - days(1),
                            hour(DATE_TIME) &gt;= 7 ~ date(DATE_TIME))) %&gt;% 
    summarize(tavg_C=mean(TEMPERATURE), tmax_C=max(TEMPERATURE), tmin_C=min(TEMPERATURE), 
              prcp_mm = sum(PRECIPITATION), across(where(is.numeric), mean)) </code></pre>
</div>
<div id="noaa" class="section level2">
<h2>NOAA</h2>
<p>Weather data from 7 stations near RMBL sourced from <a href="https://www.ncdc.noaa.gov/data-access/land-based-station-data/land-based-datasets/global-historical-climatology-network-ghcn">NOAA’s GHCN Daily dataset</a>.</p>
<ul>
<li>All stations within 10 km of Maxfield Meadow near Gothic</li>
<li>Daily summaries quality checked by GHCN</li>
<li>Includes long records from Crested Butte (1909-present), Schofield Pass (1985-present), Butte (1980-present)</li>
<li>The Crested Butte station precip is <a href="https://www.ncdc.noaa.gov/homr/#ncdcstnid=20003581&amp;tab=PHR">collected at 9:00 am</a>, but the collection time is unknown for Schofield Pass and Butte, which are probably automated (midnight-midnight)</li>
<li>Stations beginning with US1COGN (Colorado-Gunnison County) are <a href="https://www.cocorahs.org/Stations/ListStations.aspx">community CoCoRaHS stations</a>, including <a href="https://www.ncdc.noaa.gov/cdo-web/datasets/GHCND/stations/GHCND:US1COGN0018/detail">billy barr’s</a> <a href="https://www.cocorahs.org/Stations/Station.aspx?StationNumber=CO-GN-18">station in Gothic</a>. Unlike some the other datasets, the reported precipitation is from 7 am the previous day to 7 am that day, according to <a href="https://www.cocorahs.org/ViewData/ListDailyPrecipReports.aspx">CoCoRaHS</a>. For some stations, it ranges from 6:30-8:00 am.</li>
<li>To handle this discrepancy coarsely, the date is set to the day before on CoCoRaHS stations and NOAA Crested Butte, since most hours of precip are from day prior, and most summer precipitation is in the afternoon.</li>
<li>Then in compared hourly datasets (EPA, WRCC, ESSDIVE), the date is set to the day prior for precip collected before 7 am.</li>
</ul>
<pre class="r"><code>library(rnoaa)
station_data &lt;- ghcnd_stations()# long download unless cached
NOAA_stations &lt;- meteo_nearby_stations(lat_lon_df = maxfield_coords, station_data = station_data,
                      var = c(&quot;PRCP&quot;, &quot;TAVG&quot;), radius = 10)$maxfield %&gt;% #stations within 10 km radius of Maxfield
    left_join(station_data %&gt;% filter(element==&quot;PRCP&quot;)) %&gt;% 
  mutate(CoCoRaHS = str_sub(id,1,3) == &quot;US1&quot;)
remove(station_data)
NOAA_stations_name &lt;- with(NOAA_stations, set_names(name, id))
NOAA_stations_morning &lt;- NOAA_stations %&gt;% filter(CoCoRaHS) %&gt;% pull(id) %&gt;% c(&quot;USC00051959&quot;) #Crested Butte is collected in the morning too, at 9am

daily_NOAA &lt;- meteo_pull_monitors(NOAA_stations$id, keep_flags = T) %&gt;% 
  mutate(across(contains(&quot;flag&quot;), as.factor)) %&gt;% #All units are in tenths of mm, converted to mm here.
  mutate(across(c(&quot;prcp&quot;,&quot;snow&quot;,&quot;snwd&quot;,&quot;wesd&quot;,&quot;wesf&quot;), ~ as.integer(.x)/10, .names=&quot;{.col}_mm&quot;), .keep=&quot;unused&quot;) %&gt;% 
  mutate(across(c(&quot;tmin&quot;,&quot;tavg&quot;,&quot;tmax&quot;), ~ as.integer(.x)/10, .names=&quot;{.col}_C&quot;), .keep=&quot;unused&quot;) %&gt;% 
  mutate(date = case_when(id %in% NOAA_stations_morning ~ date - days(1), TRUE ~ date)) %&gt;% # CoCoRaHS stations are recorded the next day at 7 am (and CB at 9 am), so set them back a day
  mutate(prcp_mm = ifelse(id==&quot;USC00051959&quot; &amp; date %in% c(ymd(&quot;2000-08-03&quot;),ymd(&quot;2018-07-28&quot;)), NA, prcp_mm)) #cut 2 extreme precip values at CB station not recorded by other stations</code></pre>
</div>
<div id="cocorahs" class="section level2">
<h2>CoCoRaHS</h2>
<p>Community precipitation monitoring stations using manual gauges emptied in the morning (around 7 am local).</p>
<ul>
<li>The NOAA dataset includes a few of these stations</li>
<li>Daily reports exported from directly from <a href="http://data.cocorahs.org/cocorahs/export/exportmanager.aspx">CoCoRaHS</a> for <a href="http://data.cocorahs.org/export/exportreports.aspx?ReportType=Daily&amp;dtf=1&amp;Format=CSV&amp;State=CO&amp;County=GN&amp;ReportDateType=reportdate&amp;StartDate=4/6/2000&amp;EndDate=4/6/2021&amp;TimesInGMT=False">Gunnison County, CO since 2000</a></li>
<li>Plots of data coverage and observation times, table of currently active stations</li>
<li>See complete <a href="data/NOAA_GHCN/CoCoRaHS_Stations_CO_GN.tsv">Gunnison County station list</a></li>
</ul>
<pre class="r"><code>daily_CoCoRaHS &lt;- read_csv(&quot;data/NOAA_GHCN/CoCoRaHS_DailyPrecipReports_CO_GN.csv&quot;, guess_max=1e4) %&gt;% 
  mutate(across(TotalPrecipAmt:TotalSnowSWE, ~25.4*as.numeric(.x)),# T(race) to NA, convert inches to mm
         across(starts_with(&quot;Station&quot;), factor)) 

ggplot(daily_CoCoRaHS, aes(x=ObservationDate, y=StationName, fill=TotalPrecipAmt)) + geom_tile()</code></pre>
<p><img src="images_weather/cocorahs-1.png" width="672" /></p>
<pre class="r"><code>ggplot(daily_CoCoRaHS, aes(x=ObservationTime, y=StationName)) + geom_point(shape=1, alpha=0.2)</code></pre>
<p><img src="images_weather/cocorahs-2.png" width="672" /></p>
<pre class="r"><code>CoCoRaHS_stations &lt;- daily_CoCoRaHS %&gt;% group_by(StationName, StationNumber) %&gt;% 
  summarize(across(c(Latitude, Longitude), unique), medianObservationTime=median(ObservationTime)) %&gt;% 
  left_join(read_tsv(&quot;data/NOAA_GHCN/CoCoRaHS_Stations_CO_GN.tsv&quot;)) 

CoCoRaHS_stations %&gt;% mutate(StationNumber = cell_spec(StationNumber, &quot;html&quot;, link = Link), .keep=&quot;unused&quot;) %&gt;%
  select(-c(Type, State, County, OldStationNumber)) %&gt;% filter(Active==&quot;Yes&quot;) %&gt;% 
  kable(&quot;html&quot;, escape = FALSE) %&gt;%  kable_styling(bootstrap_options = c(&quot;hover&quot;, &quot;condensed&quot;)) </code></pre>
<table class="table table-hover table-condensed" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
StationName
</th>
<th style="text-align:left;">
StationNumber
</th>
<th style="text-align:right;">
Latitude
</th>
<th style="text-align:right;">
Longitude
</th>
<th style="text-align:left;">
medianObservationTime
</th>
<th style="text-align:left;">
Active
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
Cimarron 11.2 S
</td>
<td style="text-align:left;">
<a href="https://www.cocorahs.org/Stations/Station.aspx?StationNumber=CO-GN-47" style="     ">CO-GN-47</a>
</td>
<td style="text-align:right;">
38.28847
</td>
<td style="text-align:right;">
-107.5550
</td>
<td style="text-align:left;">
07:00:00
</td>
<td style="text-align:left;">
Yes
</td>
</tr>
<tr>
<td style="text-align:left;">
Crested Butte 0.5 ESE
</td>
<td style="text-align:left;">
<a href="https://www.cocorahs.org/Stations/Station.aspx?StationNumber=CO-GN-70" style="     ">CO-GN-70</a>
</td>
<td style="text-align:right;">
38.86734
</td>
<td style="text-align:right;">
-106.9741
</td>
<td style="text-align:left;">
08:00:00
</td>
<td style="text-align:left;">
Yes
</td>
</tr>
<tr>
<td style="text-align:left;">
Crested Butte 1.9 NNE
</td>
<td style="text-align:left;">
<a href="https://www.cocorahs.org/Stations/Station.aspx?StationNumber=CO-GN-66" style="     ">CO-GN-66</a>
</td>
<td style="text-align:right;">
38.89471
</td>
<td style="text-align:right;">
-106.9685
</td>
<td style="text-align:left;">
07:00:00
</td>
<td style="text-align:left;">
Yes
</td>
</tr>
<tr>
<td style="text-align:left;">
Crested Butte 6.2 N
</td>
<td style="text-align:left;">
<a href="https://www.cocorahs.org/Stations/Station.aspx?StationNumber=CO-GN-18" style="     ">CO-GN-18</a>
</td>
<td style="text-align:right;">
38.96030
</td>
<td style="text-align:right;">
-106.9908
</td>
<td style="text-align:left;">
07:00:00
</td>
<td style="text-align:left;">
Yes
</td>
</tr>
<tr>
<td style="text-align:left;">
Crested Butte 6.3 W
</td>
<td style="text-align:left;">
<a href="https://www.cocorahs.org/Stations/Station.aspx?StationNumber=CO-GN-67" style="     ">CO-GN-67</a>
</td>
<td style="text-align:right;">
38.87571
</td>
<td style="text-align:right;">
-107.0998
</td>
<td style="text-align:left;">
07:00:00
</td>
<td style="text-align:left;">
Yes
</td>
</tr>
<tr>
<td style="text-align:left;">
Doyleville 2.1 W
</td>
<td style="text-align:left;">
<a href="https://www.cocorahs.org/Stations/Station.aspx?StationNumber=CO-GN-49" style="     ">CO-GN-49</a>
</td>
<td style="text-align:right;">
38.42486
</td>
<td style="text-align:right;">
-106.6192
</td>
<td style="text-align:left;">
08:00:00
</td>
<td style="text-align:left;">
Yes
</td>
</tr>
<tr>
<td style="text-align:left;">
Gunnison 0.2 NW
</td>
<td style="text-align:left;">
<a href="https://www.cocorahs.org/Stations/Station.aspx?StationNumber=CO-GN-68" style="     ">CO-GN-68</a>
</td>
<td style="text-align:right;">
38.54689
</td>
<td style="text-align:right;">
-106.9296
</td>
<td style="text-align:left;">
07:00:00
</td>
<td style="text-align:left;">
Yes
</td>
</tr>
<tr>
<td style="text-align:left;">
Gunnison 0.8 N
</td>
<td style="text-align:left;">
<a href="https://www.cocorahs.org/Stations/Station.aspx?StationNumber=CO-GN-52" style="     ">CO-GN-52</a>
</td>
<td style="text-align:right;">
38.55570
</td>
<td style="text-align:right;">
-106.9286
</td>
<td style="text-align:left;">
08:00:00
</td>
<td style="text-align:left;">
Yes
</td>
</tr>
<tr>
<td style="text-align:left;">
Gunnison 0.8 NNW
</td>
<td style="text-align:left;">
<a href="https://www.cocorahs.org/Stations/Station.aspx?StationNumber=CO-GN-41" style="     ">CO-GN-41</a>
</td>
<td style="text-align:right;">
38.54020
</td>
<td style="text-align:right;">
-106.9238
</td>
<td style="text-align:left;">
08:00:00
</td>
<td style="text-align:left;">
Yes
</td>
</tr>
<tr>
<td style="text-align:left;">
Gunnison 2.8 NNE
</td>
<td style="text-align:left;">
<a href="https://www.cocorahs.org/Stations/Station.aspx?StationNumber=CO-GN-71" style="     ">CO-GN-71</a>
</td>
<td style="text-align:right;">
38.58036
</td>
<td style="text-align:right;">
-106.9031
</td>
<td style="text-align:left;">
07:00:00
</td>
<td style="text-align:left;">
Yes
</td>
</tr>
<tr>
<td style="text-align:left;">
Gunnison 6.6 N
</td>
<td style="text-align:left;">
<a href="https://www.cocorahs.org/Stations/Station.aspx?StationNumber=CO-GN-40" style="     ">CO-GN-40</a>
</td>
<td style="text-align:right;">
38.63912
</td>
<td style="text-align:right;">
-106.9408
</td>
<td style="text-align:left;">
07:00:00
</td>
<td style="text-align:left;">
Yes
</td>
</tr>
<tr>
<td style="text-align:left;">
Lake City 8.5 N
</td>
<td style="text-align:left;">
<a href="https://www.cocorahs.org/Stations/Station.aspx?StationNumber=CO-GN-54" style="     ">CO-GN-54</a>
</td>
<td style="text-align:right;">
38.15131
</td>
<td style="text-align:right;">
-107.2982
</td>
<td style="text-align:left;">
08:00:00
</td>
<td style="text-align:left;">
Yes
</td>
</tr>
<tr>
<td style="text-align:left;">
Marble 0.5 NNW
</td>
<td style="text-align:left;">
<a href="https://www.cocorahs.org/Stations/Station.aspx?StationNumber=CO-GN-50" style="     ">CO-GN-50</a>
</td>
<td style="text-align:right;">
39.07911
</td>
<td style="text-align:right;">
-107.1906
</td>
<td style="text-align:left;">
07:00:00
</td>
<td style="text-align:left;">
Yes
</td>
</tr>
<tr>
<td style="text-align:left;">
Parlin 2.7 ESE
</td>
<td style="text-align:left;">
<a href="https://www.cocorahs.org/Stations/Station.aspx?StationNumber=CO-GN-39" style="     ">CO-GN-39</a>
</td>
<td style="text-align:right;">
38.48433
</td>
<td style="text-align:right;">
-106.6742
</td>
<td style="text-align:left;">
07:00:00
</td>
<td style="text-align:left;">
Yes
</td>
</tr>
<tr>
<td style="text-align:left;">
Pitkin 1.1 SW
</td>
<td style="text-align:left;">
<a href="https://www.cocorahs.org/Stations/Station.aspx?StationNumber=CO-GN-59" style="     ">CO-GN-59</a>
</td>
<td style="text-align:right;">
38.59850
</td>
<td style="text-align:right;">
-106.5313
</td>
<td style="text-align:left;">
07:00:00
</td>
<td style="text-align:left;">
Yes
</td>
</tr>
<tr>
<td style="text-align:left;">
Powderhorn 4.4 NNE
</td>
<td style="text-align:left;">
<a href="https://www.cocorahs.org/Stations/Station.aspx?StationNumber=CO-GN-58" style="     ">CO-GN-58</a>
</td>
<td style="text-align:right;">
38.34010
</td>
<td style="text-align:right;">
-107.0943
</td>
<td style="text-align:left;">
08:00:00
</td>
<td style="text-align:left;">
Yes
</td>
</tr>
</tbody>
</table>
</div>
<div id="ncei" class="section level2">
<h2>NCEI</h2>
<p>Weather data from the <a href="https://www1.ncdc.noaa.gov/pub/data/gsod/readme.txt">Global Surface Summary of the Day</a> (GSOD)</p>
<ul>
<li>From NOAA’s National Centers for Environmental Information (NCEI)</li>
<li>Not currently imported - only get Gunnison/Crested Butte and Aspen airports</li>
<li><a href="https://www1.ncdc.noaa.gov/pub/data/noaa/isd-inventory.txt">List of stations</a></li>
</ul>
<pre class="r"><code>library(GSODR)
gsodr.inventory &lt;- get_inventory() %&gt;% #long download
  filter(STNID %in% nearest_stations(38.9495, -106.9908,50))</code></pre>
</div>
<div id="gothicwx" class="section level2">
<h2>gothicwx</h2>
<p><a href="http://www.gothicwx.org/ground-cover.html">billy barr’s snow records in Gothic, CO</a></p>
<pre class="r"><code>groundcover &lt;- read_tsv(&quot;./data/gothicwx/groundcover.tsv&quot;) %&gt;% 
  mutate(across(starts_with(&quot;first&quot;), list(day=yday)), year=year(first_0_cm))

groundcover_2021 &lt;- tibble(first_snow=ymd(&quot;2020-10-25&quot;), first_0_cm=ymd(&quot;2021-05-01&quot;)) 
#TODO check this first permanent snow of 2020 (not yet on billy&#39;s website), and fill in actual value for first_0_cm

get_seasons &lt;- function(dates) { 
  factor(c(&quot;smmr&quot;,&quot;wntr&quot;))[ifelse(year(dates) &lt; min(groundcover$year), NA, 
         1+dates %in% do.call(c, 
                             map2(bind_rows(groundcover, groundcover_2021)$first_snow, 
                                  bind_rows(groundcover, groundcover_2021)$first_0_cm, 
                                  ~ seq(date(.x), date(.y), by=&quot;day&quot;))))]
}</code></pre>
</div>
<div id="combine-datasets" class="section level2">
<h2>Combine datasets</h2>
<p>Combine selected daily weather station data in long or wide format.</p>
<pre class="r"><code>#Combine a few of the closer weather station precipitation datasets and snowmelt in wide format
daily_all &lt;- 
  daily_NOAA %&gt;% filter(id == &quot;US1COGN0018&quot;) %&gt;% 
  full_join(daily_GTH161) %&gt;% full_join(daily_KCOMTCRE2) %&gt;% 
  full_join(daily_WRCC %&gt;% filter(id==&quot;CORBIL&quot;), by=&quot;date&quot;) %&gt;% 
  rename(EPA_RsrchMdw=PRECIPITATION, ESSDIVE_GoldLink=Precip, WRCC_billy=precip_mm, NOAA_billy=prcp_mm) %&gt;% 
  mutate(yr = year(date), mo = month(date, label=F),
         ground_covered = get_seasons(date)) %&gt;% filter(year(date) &lt; 2021)

#Combine all the weather stations daily precip and temperature statistics in long format
daily_long &lt;- bind_rows( 
  GTH161 = daily_GTH161_NA %&gt;% select(date, tavg_C, tmax_C, tmin_C, prcp_mm),
  KCOMTCRE2 = daily_KCOMTCRE2 %&gt;% select(date, tavg_C = Tmean, tmax_C = Tmax, tmin_C = Tmin, prcp_mm = Precip),
  .id=&quot;id&quot;) %&gt;% 
  bind_rows(daily_WRCC %&gt;% select(id, date, tavg_C = av_temp_air_C, 
                                  tmax_C = max_av_temp_air_C, tmin_C = min_av_temp_air_C, 
                                  prcp_mm = precip_mm)) %&gt;%  
  bind_rows(daily_NOAA %&gt;% select(id, date, tavg_C, tmax_C, tmin_C, prcp_mm)) %&gt;% mutate(id=factor(id))%&gt;% filter(year(date) &lt; 2021)

# The datasets summarized to line up with the morning collections
daily_long_7am &lt;- bind_rows( 
  GTH161 = daily_GTH161_NA_7am %&gt;% select(date, prcp_mm),
  KCOMTCRE2 = daily_KCOMTCRE2_7am %&gt;% select(date, prcp_mm = Precip), .id=&quot;id&quot;) %&gt;% 
  bind_rows(daily_WRCC_7am %&gt;% select(id, date, prcp_mm = precip_mm)) %&gt;%  
  bind_rows(daily_NOAA %&gt;% select(id, date, prcp_mm)) %&gt;% # morning stations shifted back a day
  mutate(ground_covered = get_seasons(date)) %&gt;% filter(year(date) &lt; 2021)

daily_all_7am &lt;- daily_long_7am %&gt;% 
  pivot_wider(names_from=&quot;id&quot;, values_from=&quot;prcp_mm&quot;) %&gt;% arrange(date)</code></pre>
</div>
</div>
<div id="stations" class="section level1">
<h1>Stations</h1>
<div id="metadata" class="section level2">
<h2>Metadata</h2>
<p>List the weather station metadata</p>
<ul>
<li>Links point to the data sources</li>
<li>Distance is from Maxfield Meadow</li>
<li>Years show the range of the precipitation record (NA if no precipitation data)</li>
</ul>
<pre class="r"><code>all_stations &lt;- bind_rows(
  NOAA_stations %&gt;% mutate(source=&quot;NOAA&quot;, url=paste0(&quot;https://www.ncdc.noaa.gov/cdo-web/datasets/GHCND/stations/GHCND:&quot;,id,&quot;/detail&quot;)), 
  read_tsv(&quot;data/stations.tsv&quot;) %&gt;% 
  rnoaa::meteo_process_geographic_data(lat = maxfield_coords$latitude, long = maxfield_coords$long) %&gt;% 
    mutate(element=&quot;PRCP&quot;)) %&gt;% 
  mutate(source_name = paste(source, name, sep=&quot;_&quot;), 
         short_name = str_replace(name, &quot;CRESTED BUTTE&quot;,&quot;CB&quot;),
         color = c(brewer.pal(8, &quot;Set1&quot;), &quot;black&quot;, brewer.pal(9, &quot;Set1&quot;)[9], brewer.pal(6, &quot;Dark2&quot;))) %&gt;% 
  rows_patch(daily_long %&gt;% drop_na(prcp_mm)  %&gt;% group_by(id) %&gt;% summarize(first_year=min(year(date)), last_year=max(year(date))))
stations_pal &lt;- with(all_stations, set_names(color, short_name))
stations_name &lt;- with(all_stations, set_names(short_name, id))
stations_source_name &lt;- with(all_stations, set_names(source_name, id))

all_stations %&gt;% select(-c(state, gsn_flag, wmo_id, source_name, short_name, color)) %&gt;% relocate(source) %&gt;% 
  write_tsv(&quot;data/all_stations.tsv&quot;) %&gt;% 
  mutate(id = cell_spec(id, &quot;html&quot;, link = url), .keep=&quot;unused&quot;) %&gt;%
  kable(&quot;html&quot;, escape = FALSE) %&gt;%  kable_styling(bootstrap_options = c(&quot;hover&quot;, &quot;condensed&quot;)) </code></pre>
<table class="table table-hover table-condensed" style="margin-left: auto; margin-right: auto;">
<thead>
<tr>
<th style="text-align:left;">
source
</th>
<th style="text-align:left;">
id
</th>
<th style="text-align:left;">
name
</th>
<th style="text-align:right;">
latitude
</th>
<th style="text-align:right;">
longitude
</th>
<th style="text-align:right;">
distance
</th>
<th style="text-align:right;">
elevation
</th>
<th style="text-align:left;">
element
</th>
<th style="text-align:right;">
first_year
</th>
<th style="text-align:right;">
last_year
</th>
<th style="text-align:left;">
CoCoRaHS
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left;">
NOAA
</td>
<td style="text-align:left;">
<a href="https://www.ncdc.noaa.gov/cdo-web/datasets/GHCND/stations/GHCND:US1COGN0018/detail" style="     ">US1COGN0018</a>
</td>
<td style="text-align:left;">
CRESTED BUTTE 6.2 N
</td>
<td style="text-align:right;">
38.96030
</td>
<td style="text-align:right;">
-106.9908
</td>
<td style="text-align:right;">
1.2009052
</td>
<td style="text-align:right;">
2927.9
</td>
<td style="text-align:left;">
PRCP
</td>
<td style="text-align:right;">
2004
</td>
<td style="text-align:right;">
2021
</td>
<td style="text-align:left;">
TRUE
</td>
</tr>
<tr>
<td style="text-align:left;">
NOAA
</td>
<td style="text-align:left;">
<a href="https://www.ncdc.noaa.gov/cdo-web/datasets/GHCND/stations/GHCND:US1COGN0030/detail" style="     ">US1COGN0030</a>
</td>
<td style="text-align:left;">
MOUNT CRESTED BUTTE 0.3 ENE
</td>
<td style="text-align:right;">
38.91030
</td>
<td style="text-align:right;">
-106.9623
</td>
<td style="text-align:right;">
5.0076927
</td>
<td style="text-align:right;">
2941.0
</td>
<td style="text-align:left;">
PRCP
</td>
<td style="text-align:right;">
2008
</td>
<td style="text-align:right;">
2010
</td>
<td style="text-align:left;">
TRUE
</td>
</tr>
<tr>
<td style="text-align:left;">
NOAA
</td>
<td style="text-align:left;">
<a href="https://www.ncdc.noaa.gov/cdo-web/datasets/GHCND/stations/GHCND:US1COGN0066/detail" style="     ">US1COGN0066</a>
</td>
<td style="text-align:left;">
CRESTED BUTTE 1.9 NNE
</td>
<td style="text-align:right;">
38.89470
</td>
<td style="text-align:right;">
-106.9685
</td>
<td style="text-align:right;">
6.3915733
</td>
<td style="text-align:right;">
2822.4
</td>
<td style="text-align:left;">
PRCP
</td>
<td style="text-align:right;">
2017
</td>
<td style="text-align:right;">
2021
</td>
<td style="text-align:left;">
TRUE
</td>
</tr>
<tr>
<td style="text-align:left;">
NOAA
</td>
<td style="text-align:left;">
<a href="https://www.ncdc.noaa.gov/cdo-web/datasets/GHCND/stations/GHCND:USS0006L11S/detail" style="     ">USS0006L11S</a>
</td>
<td style="text-align:left;">
Butte
</td>
<td style="text-align:right;">
38.89000
</td>
<td style="text-align:right;">
-106.9500
</td>
<td style="text-align:right;">
7.4987757
</td>
<td style="text-align:right;">
3096.8
</td>
<td style="text-align:left;">
PRCP
</td>
<td style="text-align:right;">
1980
</td>
<td style="text-align:right;">
2021
</td>
<td style="text-align:left;">
FALSE
</td>
</tr>
<tr>
<td style="text-align:left;">
NOAA
</td>
<td style="text-align:left;">
<a href="https://www.ncdc.noaa.gov/cdo-web/datasets/GHCND/stations/GHCND:USC00051959/detail" style="     ">USC00051959</a>
</td>
<td style="text-align:left;">
CRESTED BUTTE
</td>
<td style="text-align:right;">
38.87390
</td>
<td style="text-align:right;">
-106.9772
</td>
<td style="text-align:right;">
8.4882935
</td>
<td style="text-align:right;">
2702.7
</td>
<td style="text-align:left;">
PRCP
</td>
<td style="text-align:right;">
1909
</td>
<td style="text-align:right;">
2020
</td>
<td style="text-align:left;">
FALSE
</td>
</tr>
<tr>
<td style="text-align:left;">
NOAA
</td>
<td style="text-align:left;">
<a href="https://www.ncdc.noaa.gov/cdo-web/datasets/GHCND/stations/GHCND:US1COGN0020/detail" style="     ">US1COGN0020</a>
</td>
<td style="text-align:left;">
CRESTED BUTTE 0.5 ENE
</td>
<td style="text-align:right;">
38.87220
</td>
<td style="text-align:right;">
-106.9780
</td>
<td style="text-align:right;">
8.6664240
</td>
<td style="text-align:right;">
2706.0
</td>
<td style="text-align:left;">
PRCP
</td>
<td style="text-align:right;">
2004
</td>
<td style="text-align:right;">
2011
</td>
<td style="text-align:left;">
TRUE
</td>
</tr>
<tr>
<td style="text-align:left;">
NOAA
</td>
<td style="text-align:left;">
<a href="https://www.ncdc.noaa.gov/cdo-web/datasets/GHCND/stations/GHCND:USS0007K11S/detail" style="     ">USS0007K11S</a>
</td>
<td style="text-align:left;">
Schofield Pass
</td>
<td style="text-align:right;">
39.02000
</td>
<td style="text-align:right;">
-107.0500
</td>
<td style="text-align:right;">
9.3614039
</td>
<td style="text-align:right;">
3261.4
</td>
<td style="text-align:left;">
PRCP
</td>
<td style="text-align:right;">
1985
</td>
<td style="text-align:right;">
2020
</td>
<td style="text-align:left;">
FALSE
</td>
</tr>
<tr>
<td style="text-align:left;">
EPA
</td>
<td style="text-align:left;">
<a href="https://www3.epa.gov/castnet/site_pages/GTH161.html" style="     ">GTH161</a>
</td>
<td style="text-align:left;">
RsrchMdw
</td>
<td style="text-align:right;">
38.95627
</td>
<td style="text-align:right;">
-106.9859
</td>
<td style="text-align:right;">
0.8651189
</td>
<td style="text-align:right;">
2915.0
</td>
<td style="text-align:left;">
PRCP
</td>
<td style="text-align:right;">
1989
</td>
<td style="text-align:right;">
2011
</td>
<td style="text-align:left;">
NA
</td>
</tr>
<tr>
<td style="text-align:left;">
EPA_NOAA
</td>
<td style="text-align:left;">
<a href="https://www3.epa.gov/castnet/site_pages/GTH161.html" style="     ">EPA_NOAA_filled</a>
</td>
<td style="text-align:left;">
RsrchMdw_filled
</td>
<td style="text-align:right;">
38.95627
</td>
<td style="text-align:right;">
-106.9859
</td>
<td style="text-align:right;">
0.8651189
</td>
<td style="text-align:right;">
2915.0
</td>
<td style="text-align:left;">
PRCP
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:left;">
NA
</td>
</tr>
<tr>
<td style="text-align:left;">
WRCC
</td>
<td style="text-align:left;">
<a href="https://wrcc.dri.edu/cgi-bin/rawMAIN.pl?corbil" style="     ">CORBIL</a>
</td>
<td style="text-align:left;">
billy
</td>
<td style="text-align:right;">
38.96300
</td>
<td style="text-align:right;">
-106.9930
</td>
<td style="text-align:right;">
1.5131369
</td>
<td style="text-align:right;">
2917.0
</td>
<td style="text-align:left;">
PRCP
</td>
<td style="text-align:right;">
2015
</td>
<td style="text-align:right;">
2020
</td>
<td style="text-align:left;">
NA
</td>
</tr>
<tr>
<td style="text-align:left;">
WRCC
</td>
<td style="text-align:left;">
<a href="https://wrcc.dri.edu/cgi-bin/rawMAIN.pl?corjud" style="     ">CORJUD</a>
</td>
<td style="text-align:left;">
JuddFalls
</td>
<td style="text-align:right;">
38.96400
</td>
<td style="text-align:right;">
-106.9840
</td>
<td style="text-align:right;">
1.7161922
</td>
<td style="text-align:right;">
3004.0
</td>
<td style="text-align:left;">
PRCP
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:left;">
NA
</td>
</tr>
<tr>
<td style="text-align:left;">
WRCC
</td>
<td style="text-align:left;">
<a href="https://wrcc.dri.edu/cgi-bin/rawMAIN.pl?corket" style="     ">CORKET</a>
</td>
<td style="text-align:left;">
KettlePonds
</td>
<td style="text-align:right;">
38.94200
</td>
<td style="text-align:right;">
-106.9730
</td>
<td style="text-align:right;">
1.7507490
</td>
<td style="text-align:right;">
2860.0
</td>
<td style="text-align:left;">
PRCP
</td>
<td style="text-align:right;">
2015
</td>
<td style="text-align:right;">
2016
</td>
<td style="text-align:left;">
NA
</td>
</tr>
<tr>
<td style="text-align:left;">
WRCC
</td>
<td style="text-align:left;">
<a href="https://wrcc.dri.edu/cgi-bin/rawMAIN.pl?corsno" style="     ">CORSNO</a>
</td>
<td style="text-align:left;">
Snodgrass
</td>
<td style="text-align:right;">
38.93300
</td>
<td style="text-align:right;">
-106.9860
</td>
<td style="text-align:right;">
1.8810956
</td>
<td style="text-align:right;">
3396.0
</td>
<td style="text-align:left;">
PRCP
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:left;">
NA
</td>
</tr>
<tr>
<td style="text-align:left;">
ESSDIVE
</td>
<td style="text-align:left;">
<a href="https://doi.org/doi:10.15485/1734790" style="     ">KCOMTCRE2</a>
</td>
<td style="text-align:left;">
GoldLink
</td>
<td style="text-align:right;">
38.91500
</td>
<td style="text-align:right;">
-106.9590
</td>
<td style="text-align:right;">
4.7204356
</td>
<td style="text-align:right;">
2926.0
</td>
<td style="text-align:left;">
PRCP
</td>
<td style="text-align:right;">
2011
</td>
<td style="text-align:right;">
2020
</td>
<td style="text-align:left;">
NA
</td>
</tr>
<tr>
<td style="text-align:left;">
WRCC
</td>
<td style="text-align:left;">
<a href="https://wrcc.dri.edu/cgi-bin/rawMAIN.pl?cormex" style="     ">CORMEX</a>
</td>
<td style="text-align:left;">
MexicanCut
</td>
<td style="text-align:right;">
39.02800
</td>
<td style="text-align:right;">
-107.0640
</td>
<td style="text-align:right;">
10.7804142
</td>
<td style="text-align:right;">
3412.0
</td>
<td style="text-align:left;">
PRCP
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:left;">
NA
</td>
</tr>
<tr>
<td style="text-align:left;">
WRCC
</td>
<td style="text-align:left;">
<a href="https://wrcc.dri.edu/cgi-bin/rawMAIN.pl?coralm" style="     ">CORALM</a>
</td>
<td style="text-align:left;">
Almont
</td>
<td style="text-align:right;">
38.65500
</td>
<td style="text-align:right;">
-106.8620
</td>
<td style="text-align:right;">
34.5967136
</td>
<td style="text-align:right;">
2469.0
</td>
<td style="text-align:left;">
PRCP
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:right;">
NA
</td>
<td style="text-align:left;">
NA
</td>
</tr>
</tbody>
</table>
</div>
<div id="map" class="section level2">
<h2>Map</h2>
<p>Map of stations, excluding Almont</p>
<pre class="r"><code>library(OpenStreetMap)
map &lt;- openmap(c(39.05, -107.1), c(38.85, -106.9), type = &quot;stamen-terrain&quot;)
map.latlon &lt;- openproj(map, projection = &quot;+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs&quot;)
autoplot(map.latlon) + 
  geom_point(data=filter(all_stations, !(id %in% c(&quot;CORALM&quot;, &quot;EPA_NOAA_filled&quot;))), 
             aes(x=longitude, y=latitude, color=short_name), size=2) + 
  theme(legend.position=&quot;bottom&quot;, axis.title=element_blank()) + labs(color=&quot;Station&quot;) +
  scale_color_manual(values=stations_pal)</code></pre>
<p><img src="images_weather/station_map-1.png" width="672" /></p>
</div>
</div>
<div id="data-coverage" class="section level1">
<h1>Data coverage</h1>
<p>The range that each station was active collecting precipitation or temperature data. Note that data have not been cleaned at all yet, so there are unrealistic extreme values.</p>
<pre class="r"><code>ggplot(daily_long, aes(x=date, y=id, fill=prcp_mm)) + geom_tile() +
  scale_y_discrete(labels=stations_source_name) + 
  labs(y=&quot;Station&quot;,x=&quot;Year&quot;, fill=&quot;Daily precipitation (mm)&quot;) + 
  theme_minimal() + theme(legend.position = &quot;top&quot;)</code></pre>
<p><img src="images_weather/coverage-1.png" width="672" /></p>
<pre class="r"><code>ggplot(daily_long, aes(x=date, y=id, fill=tmax_C)) + geom_tile() +
  scale_y_discrete(labels=stations_source_name) + scale_color_viridis_c(option=&quot;inferno&quot;) +
  labs(y=&quot;Station&quot;,x=&quot;Year&quot;, fill=&quot;Maximum temperature (C)&quot;) + 
  theme_minimal() + theme(legend.position = &quot;top&quot;)</code></pre>
<p><img src="images_weather/coverage-2.png" width="672" /></p>
</div>
<div id="compare-daily-precip" class="section level1">
<h1>Compare daily precip</h1>
<p>Compare summer precipitation data across <a href="#stations">stations</a>.</p>
<ul>
<li>The correlation plots show how precipitation measurements are correlated on the daily scale, after shifting the stations with morning collections back a day and grouping measurements in the hourly datasets before 7 am to the previous day.</li>
<li>Only summer data is shown in the correlation plot, as determined by billy’s gothicwx groundcover data.</li>
<li>View the <a href="%22images_weather/corrplot_7am.pdf%22">full correlation plot matrix</a> to compare all the stations.</li>
</ul>
<pre class="r"><code>daily_long_7am %&gt;% mutate(yr = year(date)) %&gt;% 
  filter(yday(date) &gt;100, yday(date) &lt; 240, yr %in% 2018:2020) %&gt;%
  ggplot(aes(x=yday(date), y=prcp_mm, color=stations_name[id], shape=ground_covered)) +  
  geom_point() + facet_wrap(vars(yr)) + scale_color_manual(values=stations_pal) + #ncol=1 
  labs(x=&quot;Day of year&quot;, y = &quot;Precipitation (mm)&quot;, color=&quot;Station&quot;, shape=&quot;Snow cover&quot;) + 
  theme(legend.position = &quot;top&quot;)</code></pre>
<p><img src="images_weather/weather_daily-1.png" width="672" /></p>
<pre class="r"><code>ggcorr(daily_all_7am %&gt;% filter(ground_covered==&quot;smmr&quot;) %&gt;% 
          select(-c(date, ground_covered)) %&gt;% rename_with(~ stations_source_name[.x]), 
       layout.exp=0.5, geom=&quot;tile&quot;, label_size=3, label=T, name=&quot;r&quot;, hjust = .9, size = 2.5)</code></pre>
<p><img src="images_weather/weather_daily-2.png" width="672" /></p>
<pre class="r"><code>precip_max &lt;- 50
scatter_continuous &lt;- function (data, mapping, method=&quot;p&quot;, use=&quot;pairwise&quot;, ...) {
  corr &lt;- cor(eval_data_col(data, mapping$x), eval_data_col(data, mapping$y), method=method, use=use)
  colFn &lt;- colorRampPalette(c(&quot;blue&quot;, &quot;white&quot;, &quot;red&quot;), interpolate =&#39;spline&#39;)
  fill &lt;- colFn(100)[findInterval(corr, seq(-1, 1, length=100))]
  ggally_smooth(data = data, mapping = mapping, ..., method = &quot;loess&quot;, color=&quot;blue&quot;, se=F, span=0.3) +
    ggplot2::annotate(&quot;text&quot;, x=40, y=10, label = round(corr,2))+ 
        theme_classic() + theme(panel.background = element_rect(fill=fill)) +
    scale_shape_manual(values=c(1,2))+
    coord_cartesian(xlim=c(0,precip_max), ylim=c(0,precip_max)) + geom_abline(slope=1, intercept=0)+
    scale_x_continuous(breaks=seq(0,precip_max, by=precip_max/5))+
    scale_y_continuous(breaks=seq(0,precip_max, by=precip_max/5))
}
facethist_combo &lt;- function (data, mapping, ...) {
    ggally_facethist(data = data, mapping = mapping, binwidth=precip_max/50,...) +
    coord_cartesian(xlim=c(0,precip_max)) + scale_x_continuous(breaks=seq(0,precip_max, by=precip_max/5))
}
corrplot_7am &lt;- ggpairs(daily_all_7am %&gt;% filter(ground_covered==&quot;smmr&quot;) %&gt;% 
          select(-c(date, ground_covered)) %&gt;% rename_with(~ stations_name[.x]), 
        lower=list(continuous=wrap(scatter_continuous), na=&quot;blank&quot;), 
        upper=list(continuous=wrap(scatter_continuous), na=&quot;blank&quot;))
ggsave(&quot;images_weather/corrplot_7am.pdf&quot;, corrplot_7am, device=cairo_pdf, height=10, width=12)</code></pre>
</div>
<div id="fill-in-research-meadow-precip-data" class="section level1">
<h1>Fill in Research Meadow precip data</h1>
<p>EPA precip data from the Research Meadow ends in 2011 and has some small gaps that need to be filled in to get accurate summer totals.</p>
<ul>
<li>For both of these methods, the EPA precipitation data (GTH161) is summed from 7 am to 7 am to match the collections at CoCoRaHs stations and NOAA Crested Butte (actually 9 am), and count hours before 7am as the previous day</li>
</ul>
<div id="regression-method---not-used" class="section level2">
<h2>Regression method - not used</h2>
<ul>
<li>Uses a simple linear model for their period of overlap, forced through zero</li>
<li>Fit separately for summer vs. winter (determined by billy’s groundcover data)</li>
<li>billy’s Gothic CoCoRaHs data fills gaps from 2012-present, and small gaps from 2004-2011 (US1COGN0018, summer r = 0.90)</li>
<li>Before that (1989-2004), small gaps are filled with a similar regression to the NOAA Crested Butte station (USC00051959, summer r = 0.75)</li>
<li>Regressions are not a great method since they are influenced strongly by large precip events</li>
<li>Give different slopes when run on daily or monthly scales</li>
<li>Use the Normal Ratio Method instead (see below)</li>
</ul>
<pre class="r"><code># EPA_billy_daily_model &lt;-  lm(GTH161 ~ US1COGN0018:ground_covered + 0, data=daily_all_7am)
# EPA_CB_daily_model &lt;-     lm(GTH161 ~ USC00051959:ground_covered + 0, data=daily_all_7am)
# 
# daily_filled_7am &lt;- daily_all_7am %&gt;% 
#   mutate(EPA_NOAA_source = ifelse(is.na(GTH161), ifelse(!is.na(US1COGN0018), &quot;US1COGN0018&quot;, 
#                                                                ifelse(!is.na(USC00051959), &quot;USC00051959&quot;, NA)), &quot;GTH161&quot;),
#          EPA_NOAA_filled = ifelse(is.na(GTH161), ifelse(!is.na(US1COGN0018), predict(EPA_billy_daily_model),
#                                                         ifelse(!is.na(USC00051959), predict(EPA_CB_daily_model), NA)), GTH161))

monthly_all_7am &lt;- daily_all_7am %&gt;% group_by(yr = year(date), mo = month(date)) %&gt;% 
  summarize(across(-c(date, ground_covered), 
                   ~ ifelse(sum(is.na(.x))&gt;5, NA, sum(.x, na.rm=T))), .groups=&quot;drop&quot;) %&gt;%  #tolerate 5 missing days
  arrange(yr, mo)

library(gridExtra)
grid.arrange(
  ggplot(daily_all_7am, aes(y=GTH161, x= US1COGN0018, color=ground_covered)) + coord_fixed()+
  geom_point(shape=1) + geom_smooth(span=0.3, se=F) + geom_smooth(method=&quot;lm&quot;, se=F) + geom_abline(intercept=0, slope=1) + 
   stat_poly_eq(formula = y ~ x + 0, aes(label = paste(..eq.label..,&quot;x&quot;, ..rr.label.., sep = &quot;~~~&quot;)), parse = T) +
  labs(color=&quot;Snow cover&quot;, y=stations_source_name[&quot;GTH161&quot;], x=stations_source_name[&quot;US1COGN0018&quot;], title=&quot;Daily totals&quot;),
ggplot(monthly_all_7am %&gt;%  mutate(season=factor(c(&quot;Oct-May&quot;,&quot;Jun-Sept&quot;))[1+mo %in% 6:9]),
       aes(y=GTH161, x= US1COGN0018, color=season)) + coord_fixed()+
  geom_point(shape=1) + geom_smooth(span=0.6, se=F) + geom_smooth(method=&quot;lm&quot;, formula= y ~ x + 0, se=F) + geom_abline(intercept=0, slope=1) +
   stat_poly_eq(formula = y ~ x + 0, aes(label = paste(..eq.label..,&quot;x&quot;, ..rr.label.., sep = &quot;~~~&quot;)), parse = T) +
  labs(color=&quot;Season&quot;, y=stations_source_name[&quot;GTH161&quot;], x=stations_source_name[&quot;US1COGN0018&quot;], title=&quot;Monthly totals&quot;))</code></pre>
<p><img src="images_weather/EPA_NOAA_fill-1.png" width="672" /></p>
<pre class="r"><code>grid.arrange(
ggplot(daily_all_7am, aes(y=GTH161, x= USC00051959, color=ground_covered)) + coord_fixed()+
  geom_point(shape=1) + geom_smooth(method=&quot;lm&quot;, se=F) + geom_abline(intercept=0, slope=1) + 
   stat_poly_eq(formula = y ~ x + 0, aes(label = paste(..eq.label..,&quot;x&quot;, ..rr.label.., sep = &quot;~~~&quot;)), parse = T) +
  labs(color=&quot;Snow cover&quot;, y=stations_source_name[&quot;GTH161&quot;], x=stations_source_name[&quot;USC00051959&quot;], title=&quot;Daily totals&quot;),
ggplot(monthly_all_7am %&gt;%  mutate(season=factor(c(&quot;Oct-May&quot;,&quot;Jun-Sept&quot;))[1+mo %in% 6:9]),
       aes(y=GTH161, x= USC00051959, color=season)) + coord_fixed()+
  geom_point(shape=1) + geom_smooth(span=0.6, se=F) + geom_smooth(method=&quot;lm&quot;, formula= y ~ x + 0, se=F) + geom_abline(intercept=0, slope=1) +
   stat_poly_eq(formula = y ~ x + 0, aes(label = paste(..eq.label..,&quot;x&quot;, ..rr.label.., sep = &quot;~~~&quot;)), parse = T) +
  labs(color=&quot;Season&quot;, y=stations_source_name[&quot;GTH161&quot;], x=stations_source_name[&quot;USC00051959&quot;], title=&quot;Monthly totals&quot;))</code></pre>
<p><img src="images_weather/EPA_NOAA_fill-2.png" width="672" /></p>
<pre class="r"><code>ggplot(daily_all_7am, aes(y=US1COGN0018, x= USC00051959, color=ground_covered)) + coord_fixed()+
  geom_point(shape=1) + geom_smooth(method=&quot;lm&quot;, se=F) + geom_abline(intercept=0, slope=1) + 
   stat_poly_eq(formula = y ~ x + 0, aes(label = paste(..eq.label..,&quot;x&quot;, ..rr.label.., sep = &quot;~~~&quot;)), parse = T) +
  labs(color=&quot;Snow cover&quot;, y=stations_source_name[&quot;US1COGN0018&quot;], x=stations_source_name[&quot;USC00051959&quot;], title=&quot;Daily totals&quot;)</code></pre>
<p><img src="images_weather/EPA_NOAA_fill-3.png" width="672" /></p>
</div>
<div id="normal-ratio-method" class="section level2">
<h2>Normal ratio method</h2>
<p>This method uses the ratio between the average annual precipitation at each station to fill in missing values.</p>
<ul>
<li>I adapted it to use the average of the ratios across years (since only some years overlap and the average is changing with cliamte change)</li>
<li>I only consider summer precipitation, since winter precip is less easily measured and the ratios differ</li>
<li>The plot compares the ratios of total summer/winter precip (determined by billy’s groundcover data) to the NOAA Crested Butte station (CB)</li>
<li>The EPA vs. CB summer ratio is usually close to 1 and not that variable, so all of the missing data are filled from CB.</li>
<li><a href="https://www.aboutcivil.org/analysis-of-precipitation-data.html">Guide to some precipitation imputation methods</a></li>
<li>In a paper comparing precipitation imputation methods, known as the <a href="https://iwaponline.com/hr/article/48/4/1032/1542/Assessment-of-different-methods-for-estimation-of">“UK traditional method”</a></li>
</ul>
<pre class="r"><code># total summer or winter precip relative to CB station
# calculated as daily average for each station across the season, dropping missing values
relative_to_CB &lt;- daily_all_7am %&gt;% drop_na(ground_covered) %&gt;% 
  group_by(year=year(date), ground_covered) %&gt;% summarize(across(-c(date), ~mean(.x, na.rm=T)/mean(USC00051959, na.rm=T)))

relative_to_CB %&gt;% pivot_longer(-c(year, ground_covered), names_to=&quot;id&quot;, values_to=&quot;prcp_rel_CB&quot;) %&gt;% drop_na(prcp_rel_CB) %&gt;% 
  ggplot(aes(y=stations_source_name[id], x=prcp_rel_CB, color=ground_covered))+ 
  geom_vline(xintercept=1) + geom_boxplot() + scale_x_continuous(breaks=0:6, limits=c(0,4.1))+
  labs(x=&quot;Mean daily precipitation relative to Crested Butte&quot;, y=&quot;&quot;, color=&quot;Snow cover&quot;) + theme(legend.position = &quot;top&quot;)</code></pre>
<p><img src="images_weather/EPA_CB_fill-1.png" width="672" /></p>
<pre class="r"><code>relative_to_CB %&gt;% pivot_longer(-c(year, ground_covered), names_to=&quot;id&quot;, values_to=&quot;prcp_rel_CB&quot;) %&gt;% drop_na(prcp_rel_CB) %&gt;% 
  #group_by(year, ground_covered) %&gt;% summarize(prcp_rel_CB=mean(prcp_rel_CB)) %&gt;% 
  ggplot(aes(color=stations_name[id], x= year, y=prcp_rel_CB, linetype=ground_covered))+ geom_line(size=1)+
  scale_color_manual(values=stations_pal)+ ylim(c(0,4.1))+
  labs(x=&quot;Mean daily precipitation relative to Crested Butte&quot;, y=&quot;&quot;, color=&quot;Snow cover&quot;) + theme(legend.position = &quot;top&quot;)</code></pre>
<p><img src="images_weather/EPA_CB_fill-2.png" width="672" /></p>
<pre class="r"><code>EPA_CB_summer_factor &lt;- relative_to_CB %&gt;% filter(ground_covered==&quot;smmr&quot;) %&gt;% drop_na(GTH161) %&gt;% pull(GTH161) %&gt;% mean

daily_filled_7am &lt;- daily_all_7am %&gt;% 
  mutate(EPA_NOAA_source = ifelse(is.na(GTH161), ifelse(!is.na(USC00051959), &quot;USC00051959&quot;, &quot;missing&quot;), &quot;GTH161&quot;),
         EPA_NOAA_filled = ifelse(is.na(GTH161), ifelse(!is.na(USC00051959), USC00051959*EPA_CB_summer_factor, NA), GTH161))
save(daily_filled_7am, file=&quot;data/daily_all.rda&quot;)

monthly_filled_7am &lt;- daily_filled_7am %&gt;% group_by(yr = year(date), mo = month(date)) %&gt;% 
  summarize(across(-c(date, ground_covered, EPA_NOAA_source), 
                   ~ ifelse(sum(is.na(.x))&gt;5, NA, sum(.x, na.rm=T))), .groups=&quot;drop&quot;) %&gt;%  #tolerate 5 missing days
  arrange(yr, mo)

ggplot(daily_filled_7am %&gt;% mutate(year=year(date)) %&gt;% filter(year&gt;=1989), aes(x=yday(date))) + 
  facet_wrap(vars(year)) + 
  geom_line(aes(y=40-10*as.integer(ground_covered))) + 
  geom_point(aes(y=EPA_NOAA_filled, color=stations_name[EPA_NOAA_source]), size=0.5) + 
  scale_color_manual(values=stations_pal)+
  guides(color=guide_legend(override.aes = list(size=3)))+
  labs(x=&quot;Day of year&quot;, y=&quot;EPA/NOAA precipiation (mm)&quot;, color=&quot;Filled from&quot;) + 
  theme_minimal() + theme(legend.position=&quot;top&quot;, panel.spacing = unit(0,&quot;pt&quot;), 
                          panel.grid.minor=element_blank(), panel.grid.major.x=element_blank())</code></pre>
<p><img src="images_weather/EPA_CB_fill-3.png" width="672" /></p>
</div>
</div>
<div id="monthly-precip-1989-present" class="section level1">
<h1>Monthly precip 1989-present</h1>
<ul>
<li>Recalculated Campbell and Wendlandt 2013 July average, 1989 - 2006 EPA station : 55.8954217 mm</li>
<li>Maxfield water additions per month: 14 L applied to 4 m2 every 2 days = 1.75 mm daily precip * 31 days in July = 54.25 mm.</li>
</ul>
<pre class="r"><code>monthly_filled_7am %&gt;% filter(yr&gt;=2004) %&gt;% 
  pivot_longer(-c(yr,mo), names_to=&quot;id&quot;, values_to=&quot;prcp_mm&quot;) %&gt;% 
  ggplot(aes(x=mo*30.4-15.2, y=prcp_mm, color=stations_name[id])) + facet_wrap(vars(yr)) + #place points at month midpoint
  #geom_rect(data=waterdates %&gt;% pivot_wider(names_from=precip_treatments, values_from=c(day, date)) %&gt;% mutate(yr=factor(year)), 
  #          aes(xmin=day_started, xmax=day_ended, ymin=0, ymax=water_addition_per_month_mm), inherit.aes=F,
  #          fill=water_pal[&quot;Addition&quot;])+
  geom_line() +  geom_point()+ 
    geom_line(data=daily_all_7am  %&gt;% mutate(yr=year(date)) %&gt;% filter(yr&gt;=2004),
              aes(x=yday(date), y=20-20*as.integer(ground_covered)), color=&quot;black&quot;) + 
  labs(y=&quot;Monthly precipitation (mm)&quot;, x=&quot;Day of the year, with snowmelt and first snow dates&quot;, color=&quot;Station&quot;) +
  theme(legend.position=&quot;top&quot;) + coord_cartesian(ylim=c(0,200)) + scale_color_manual(values=stations_pal)</code></pre>
<p><img src="images_weather/weather_monthly-1.png" width="672" /></p>
<pre class="r"><code>precip_max &lt;- 250
corrplot_monthly_7am &lt;- ggpairs(monthly_all_7am %&gt;% filter(mo %in% 6:9) %&gt;% 
          select(-c(yr, mo)) %&gt;% rename_with(~ stations_name[.x]), 
        lower=list(continuous=wrap(scatter_continuous), na=&quot;blank&quot;), 
        upper=list(continuous=wrap(scatter_continuous), na=&quot;blank&quot;))
ggsave(&quot;images_weather/corrplot_monthly_7am.pdf&quot;, corrplot_monthly_7am, device=cairo_pdf, height=10, width=12)

ggplot(monthly_all_7am, aes(y=GTH161,x= USC00051959, color=ifelse(mo %in% 6:9,mo,&quot;Oct - May&quot;))) + geom_point() + geom_smooth(method=&quot;lm&quot;, se=F) + geom_abline(intercept=0, slope=1) + labs(color=&quot;Month&quot;)</code></pre>
<p><img src="images_weather/weather_monthly-2.png" width="672" /></p>
<pre class="r"><code>monthly_filled_7am %&gt;% filter(yr &gt;= 1989, mo %in% 5:9) %&gt;% 
  ggplot(aes(x=mo,  y=EPA_NOAA_filled)) + geom_smooth(span=0.5, color=&quot;black&quot;) +
  geom_line(aes(color=ifelse(yr&gt;=2018, &quot;study period (est from CB)&quot;, ifelse(yr&gt;=2012,&quot;est from CB&quot;,&quot;gap-filled EPA data&quot;)), group=yr)) +
  geom_point(x=7, y=EPA_89_06_July_avg_mm)+ scale_y_continuous(limits=c(0,100))+
  geom_text(aes(label=ifelse(yr&gt;=2018, yr, &quot;&quot;)))  + 
  labs(y=&quot;Monthly precipitation (mm)&quot;, x=&quot;Month&quot;, title=&quot;EPA/NOAA summer precipitation&quot;, 
       subtitle=&quot;Black dot is mean July precipitation 1989-2006&quot;, color=&quot;Data filling&quot;) + theme(legend.position = &quot;top&quot;)</code></pre>
<p><img src="images_weather/weather_monthly-3.png" width="672" /></p>
<pre class="r"><code>monthly_filled_7am %&gt;% filter(yr &gt;= 1989, mo %in% 5:9) %&gt;% ggplot(aes(x=yr, color=factor(mo), group=mo, shape=ifelse(yr&gt;=2018, &quot;study period (est from CB)&quot;, ifelse(yr&gt;=2012,&quot;est from CB&quot;,&quot;gap-filled EPA data&quot;)), y=EPA_NOAA_filled)) +
  geom_vline(xintercept=2011.5) +geom_point() + geom_smooth(se=F, span=0.7) + 
  scale_shape_manual(values=c(1,2,19)) + scale_y_continuous(limits=c(0,100))+
  labs(x=&quot;Year&quot;,y=&quot;EPA Research Meadow monthly precipitation (mm)&quot;, color=&quot;Month&quot;, shape=&quot;Data filling&quot;) + 
  geom_segment(data=monthly_filled_7am %&gt;% filter(mo %in% 5:9, yr &lt;= 2007, yr &gt;= 1989,) %&gt;% 
                 group_by(mo) %&gt;% summarize(mean_precip=mean(EPA_NOAA_filled)), 
               aes(x=1989, xend=2006, y=mean_precip, yend=mean_precip, color=factor(mo)), inherit.aes=F, size=1) </code></pre>
<p><img src="images_weather/weather_monthly-4.png" width="672" /></p>
</div>
<div id="summer-precip-trends-1989-present" class="section level1">
<h1>Summer precip trends 1989-present</h1>
<p>Combined EPA Research Meadow / NOAA Crested Butte dataset from summers 1990-2020</p>
<pre class="r"><code>daily_filled_7am %&gt;% filter(year(date)&gt;1989, year(date)&lt;2021) %&gt;%
  mutate(julian = yday(date), decade = factor(floor(year(date)/10)*10), decade = recode(decade, &quot;2020&quot;=&quot;2010&quot;)) %&gt;%
  group_by(julian, decade) %&gt;% 
  summarize(EPA_NOAA_filled = mean(EPA_NOAA_filled, na.rm=T), ground_covered=mean(as.integer(ground_covered), na.rm=T)-1) %&gt;% 
  ggplot(aes(y=EPA_NOAA_filled, x=julian, color=decade)) + 
  geom_smooth(span=0.15, se=F)+  geom_point(shape=1, alpha=0.5) +   geom_line(aes(y=ground_covered*2), size=0.75) + 
  labs(x=&quot;Day of year&quot;, y=&quot;Mean EPA/NOAA precipiation (mm)&quot;, color=&quot;Decade&quot;, title=&quot;Snowmelt and monsoon timing by decade&quot;) +
    scale_color_brewer(palette = &quot;Set1&quot;, direction = -1) + theme_minimal()</code></pre>
<p><img src="images_weather/precip_trend-1.png" width="672" /></p>
<pre class="r"><code>daily_filled_7am %&gt;% filter(year(date)&gt;1989, year(date)&lt;2021, ground_covered==&quot;smmr&quot;, EPA_NOAA_filled &gt; 0) %&gt;%   
  mutate(decade = factor(floor(year(date)/10)*10), decade = recode(decade, &quot;2020&quot;=&quot;2010&quot;)) %&gt;% group_by(decade) %&gt;% 
  ggplot(aes(x=EPA_NOAA_filled, color=decade)) + geom_density() +
    labs(x=&quot;EPA/NOAA precipiation (mm)&quot;, y=&quot;Proportion&quot;, color=&quot;Decade&quot;, title=&quot;Intensity spectrum of summer rainstorms &gt; 0 mm&quot;) +
      scale_color_brewer(palette = &quot;Set1&quot;, direction = -1) + 
  scale_x_continuous(breaks=scales::breaks_extended(10)) + theme_minimal()</code></pre>
<p><img src="images_weather/precip_trend-2.png" width="672" /></p>
<pre class="r"><code>summary_EPA_NOAA &lt;- daily_filled_7am %&gt;% filter(year(date)&gt;1989, year(date)&lt;2021, EPA_NOAA_filled &gt; 2) %&gt;% 
  mutate(drought_days = c(0,diff(date)), year=year(date)) %&gt;% filter(ground_covered==&quot;smmr&quot;) %&gt;% 
  select(year, date, drought_days) %&gt;% group_by(year) %&gt;% summarize(max_drought_days_2mm = max(drought_days)) %&gt;% 
  left_join(daily_filled_7am  %&gt;% filter(year(date)&gt;1989, year(date)&lt;2021, ground_covered==&quot;smmr&quot;) %&gt;% group_by(year=year(date)) %&gt;% 
              summarize(snow_free_days = n(),
                        rain_days_2mm = sum(EPA_NOAA_filled &gt; 2, na.rm=T),
                        prop_rain_days_2mm = rain_days_2mm / snow_free_days,
                        max_precip_mm = max(EPA_NOAA_filled, na.rm=T),
                        avg_precip_mm = mean(EPA_NOAA_filled, na.rm=T),
                        total_precip_mm = sum(EPA_NOAA_filled, na.rm=T)))

summary_names &lt;- c(snow_free_days = &quot;Snowmelt to first permanent snowfall (days)&quot;,
                   max_drought_days_2mm=&quot;Longest drought &lt; 2 mm/day (days)&quot;, 
                   rain_days_2mm = &quot;Days with &gt; 2 mm precipitation&quot;,
                   prop_rain_days_2mm = &quot;Proportion days &gt; 2 mm precipitation&quot;,
                   max_precip_mm = &quot;Maximum precipitation (mm/day)&quot;,
                   avg_precip_mm = &quot;Average precipitation (mm/day)&quot;,
                   total_precip_mm = &quot;Total precipitation (mm)&quot;)

summary_EPA_NOAA %&gt;% pivot_longer(!year) %&gt;% filter(!name %in% c(&quot;rain_days_2mm&quot;,&quot;max_precip_mm&quot;,&quot;total_precip_mm&quot;)) %&gt;% 
  ggplot(aes(y=value, x=year))+ 
  facet_wrap(vars(name), scales=&quot;free_y&quot;, labeller=as_labeller(summary_names)) +
  annotate(&quot;rect&quot;, xmin=2017.5, xmax=2020.5, ymin=-Inf, ymax=Inf, fill=&quot;lightblue&quot;)+
  geom_smooth(method=&quot;lm&quot;, color=&quot;black&quot;, se=F) + geom_point(color=&quot;grey60&quot;) + labs(x=&quot;Year&quot;, y=&quot;&quot;) + 
  stat_poly_eq(formula = y ~ x, aes(label = paste(..eq.label.., ..rr.label.., ..p.value.label.., sep = &quot;~~~&quot;)), parse = T) +
  theme_minimal() +theme(axis.title.y= element_blank(), text=element_text(color=&quot;black&quot;, size=14), 
                         axis.text = element_text(color=&quot;black&quot;),  panel.border = element_rect(fill=NA, colour = &quot;black&quot;))</code></pre>
<p><img src="images_weather/precip_trend-3.png" width="672" /></p>
<pre class="r"><code>summary_EPA_NOAA %&gt;% summarize(across(-year, mean, na.rm=T)) %&gt;% kable(caption = &quot;Averages 1990-2020&quot;)</code></pre>
<table>
<caption>
Averages 1990-2020
</caption>
<thead>
<tr>
<th style="text-align:right;">
max_drought_days_2mm
</th>
<th style="text-align:right;">
snow_free_days
</th>
<th style="text-align:right;">
rain_days_2mm
</th>
<th style="text-align:right;">
prop_rain_days_2mm
</th>
<th style="text-align:right;">
max_precip_mm
</th>
<th style="text-align:right;">
avg_precip_mm
</th>
<th style="text-align:right;">
total_precip_mm
</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:right;">
31.70968
</td>
<td style="text-align:right;">
167.7097
</td>
<td style="text-align:right;">
29.83871
</td>
<td style="text-align:right;">
0.1785583
</td>
<td style="text-align:right;">
21.74889
</td>
<td style="text-align:right;">
1.324491
</td>
<td style="text-align:right;">
220.3063
</td>
</tr>
</tbody>
</table>
</div>
<div id="summer-precip-trends-1909-present" class="section level1">
<h1>Summer precip trends 1909-present</h1>
<p>All data from NOAA Crested Butte station.</p>
<pre class="r"><code>#weird long run of high precipitation in Sept 1927
daily_NOAA %&gt;% filter(id==&quot;USC00051959&quot;, year(date)&gt;1909, year(date)!=1927) %&gt;%
  mutate(julian = yday(date), decade = factor(floor(year(date)/10)*10), decade = recode(decade, &quot;2020&quot;=&quot;2010&quot;)) %&gt;%
  group_by(julian, decade) %&gt;% summarize(prcp_mm = mean(prcp_mm, na.rm=T)) %&gt;% 
  ggplot(aes(y=prcp_mm, x=julian, color=decade)) + geom_smooth(span=0.15, se=F)+
  labs(x=&quot;Day of year&quot;, y=&quot;Mean Crested Butte precipiation (mm)&quot;, color=&quot;Decade&quot;, title=&quot;Snowmelt and monsoon timing by decade&quot;) +
  scale_color_viridis_d(option=&quot;inferno&quot;) + coord_cartesian(xlim=c(120,270)) + theme_dark()</code></pre>
<p><img src="images_weather/precip_trend_long-1.png" width="672" /></p>
<pre class="r"><code>daily_NOAA %&gt;% filter(id==&quot;USC00051959&quot;, year(date)&gt;1909, year(date)!=1927,yday(date)&gt;=120, yday(date)&lt;= 270, prcp_mm &gt; 0) %&gt;%
  mutate(decade = factor(floor(year(date)/10)*10), decade = recode(decade, &quot;2020&quot;=&quot;2010&quot;)) %&gt;% group_by(decade) %&gt;% 
  ggplot(aes(x=prcp_mm, color=decade)) + geom_density() +
    labs(x=&quot;Crested Butte precipiation (mm)&quot;, y=&quot;Proportion&quot;, color=&quot;Decade&quot;, 
         title=&quot;Intensity spectrum of rainstorms &gt; 0 mm \n(day 120-270, Crested Butte)&quot;) +
    scale_color_viridis_d(option=&quot;inferno&quot;) +  coord_cartesian(xlim=c(0,40)) +  theme_dark()</code></pre>
<p><img src="images_weather/precip_trend_long-2.png" width="672" /></p>
<pre class="r"><code>daily_NOAA %&gt;% filter(id==&quot;USC00051959&quot;, year(date)&gt;1909, year(date)!=1927,prcp_mm &gt; 2) %&gt;%
  mutate(drought_days = c(0,diff(date)), year=year(date)) %&gt;% filter(yday(date)&gt;=120, yday(date)&lt;= 270,) %&gt;% 
  select(year, date, drought_days) %&gt;% group_by(year) %&gt;% summarize(max_drought_days = max(drought_days)) %&gt;% 
  ggplot(aes(x= year, y=max_drought_days)) + geom_smooth(span=0.5) +geom_point() +
  labs(x=&quot;Year&quot;, y=&quot;Consecutive drought days with &lt; 2 mm daily precipitation \n(day 120-270, Crested Butte)&quot;)</code></pre>
<p><img src="images_weather/precip_trend_long-3.png" width="672" /></p>
<pre class="r"><code>daily_NOAA %&gt;% filter(id==&quot;USC00051959&quot;, year(date)&gt;1909, year(date)!=1927,yday(date)&gt;=120, yday(date)&lt;= 270, prcp_mm &gt; 2) %&gt;% 
  count(year=year(date)) %&gt;% 
    ggplot(aes(x= year, y=n)) + geom_smooth(span=0.5) + geom_point() + 
  labs(x=&quot;Year&quot;, y=&quot;Days with &gt; 2 mm daily precipitation (day 120-270, Crested Butte)&quot;)</code></pre>
<p><img src="images_weather/precip_trend_long-4.png" width="672" /></p>
<pre class="r"><code>daily_NOAA %&gt;% filter(id==&quot;USC00051959&quot;, year(date)&gt;1909, year(date)!=1927, yday(date)&gt;=120, yday(date)&lt;= 270) %&gt;% 
  group_by(year=year(date)) %&gt;% summarize(total_mm=sum(prcp_mm, na.rm=T)) %&gt;% 
    ggplot(aes(x= year, y=total_mm)) + geom_smooth(span=0.5) + geom_point() + 
  labs(x=&quot;Year&quot;, y=&quot;Total precipitation (mm, day 120-270, Crested Butte)&quot;)</code></pre>
<p><img src="images_weather/precip_trend_long-5.png" width="672" /></p>
<pre class="r"><code>daily_NOAA %&gt;% filter(id==&quot;USC00051959&quot;, year(date)&gt;1909, yday(date)&gt;=120, yday(date)&lt;= 270) %&gt;% 
  group_by(year=year(date)) %&gt;% summarize(tmax_mean=mean(tmax_C, na.rm=T)) %&gt;% 
    ggplot(aes(x= year, y=tmax_mean)) + geom_smooth(span=0.3) + geom_point() + 
  labs(x=&quot;Year&quot;, y=&quot;Average maximum temperature (C, day 120-270, Crested Butte)&quot;)</code></pre>
<p><img src="images_weather/precip_trend_long-6.png" width="672" /></p>
<pre class="r"><code>daily_NOAA %&gt;% filter(id==&quot;USC00051959&quot;, year(date)&gt;1909, yday(date)&gt;=120, yday(date)&lt;= 270) %&gt;% 
  group_by(year=year(date)) %&gt;% summarize(tmin_mean=mean(tmin_C, na.rm=T)) %&gt;% 
    ggplot(aes(x= year, y=tmin_mean)) + geom_smooth(span=0.3) + geom_point() + 
  labs(x=&quot;Year&quot;, y=&quot;Average minimum temperature (C, day 120-270, Crested Butte)&quot;)</code></pre>
<p><img src="images_weather/precip_trend_long-7.png" width="672" /></p>
</div>
<div id="summer-temperature-trends-1909-present" class="section level1">
<h1>Summer temperature trends 1909-present</h1>
<pre class="r"><code>ggplot(daily_GTH161, aes(y=TEMPERATURE, x= date, color=month(date) %in% 5:7))+ geom_line(aes(group=1)) + labs(color=&quot;May-July&quot;, title=&quot;GTH161 mean temp&quot;)</code></pre>
<p><img src="images_weather/temp_trend_long-1.png" width="672" /></p>
<pre class="r"><code>daily_GTH161 %&gt;% filter(month(date) %in% 5:7) %&gt;% group_by(year=year(date)) %&gt;% summarize(days_missing=sum(is.na(TEMPERATURE))) %&gt;% print(n=23)#too much missing temp data</code></pre>
<pre><code># A tibble: 23 x 2
    year days_missing
   &lt;dbl&gt;        &lt;int&gt;
 1  1989            0
 2  1990           58
 3  1991           61
 4  1992            9
 5  1993            0
 6  1994            2
 7  1995            6
 8  1996            0
 9  1997            8
10  1998           17
11  1999            0
12  2000           19
13  2001           14
14  2002            0
15  2003            0
16  2004           16
17  2005            0
18  2006            9
19  2007            0
20  2008            0
21  2009            0
22  2010            0
23  2011            0</code></pre>
<pre class="r"><code>ggplot(daily_NOAA %&gt;% filter(id==&quot;USC00051959&quot;), aes(y=tmax_C, x= date))+ geom_line() + labs(&quot;CB max temp&quot;) #CB station does not have mean temp, only max and min</code></pre>
<p><img src="images_weather/temp_trend_long-2.png" width="672" /></p>
<pre class="r"><code>daily_NOAA  %&gt;% filter(id==&quot;USC00051959&quot;, year(date)&gt;1909, month(date) %in% 5:7) %&gt;% group_by(year=year(date)) %&gt;% 
  summarize(tmax_C_mean = mean(tmax_C, na.rm=T), days_missing=sum(is.na(tmax_C))) %&gt;% ggplot(aes(x=year, y=tmax_C_mean)) + geom_point() + geom_smooth()</code></pre>
<p><img src="images_weather/temp_trend_long-3.png" width="672" /></p>
</div>
<div id="snowmelt-timing-1976-present" class="section level1">
<h1>Snowmelt timing 1976-present</h1>
<pre class="r"><code>groundcover %&gt;% mutate(first_snow_day=first_snow_day-365) %&gt;% 
  pivot_longer(ends_with(&quot;day&quot;), names_to=&quot;threshold&quot;, values_to=&quot;day&quot;) %&gt;% drop_na(day) %&gt;% select(-starts_with(&quot;first&quot;)) %&gt;% 
  mutate(threshold = fct_reorder(factor(threshold),day, na.rm=T, .desc=T)) %&gt;% 
  ggplot(aes(x=year, y=day, color=threshold)) +  
  geom_line(aes(group=year), size=2)+ geom_smooth( method=&quot;lm&quot;, se=F) +geom_point() +
  scale_x_continuous(minor_breaks = 1976:2020, position = &quot;top&quot;) + scale_y_continuous(n.breaks=10)+
  scale_color_grey(labels=function(x) str_to_sentence(str_replace_all(x, &quot;_&quot;, &quot; &quot;)), start=0, end=0.85) +
  labs(x=&quot;Year&quot;, y=&quot;Day of year&quot;, color=&quot;Threshold&quot;) + theme_minimal()</code></pre>
<p><img src="images_weather/groundcover-1.png" width="672" /></p>
</div>



</div>
</div>

</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("hide" === "show");
});
</script>

<script>
$(document).ready(function ()  {

    // move toc-ignore selectors from section div to header
    $('div.section.toc-ignore')
        .removeClass('toc-ignore')
        .children('h1,h2,h3,h4,h5').addClass('toc-ignore');

    // establish options
    var options = {
      selectors: "h1,h2,h3",
      theme: "bootstrap3",
      context: '.toc-content',
      hashGenerator: function (text) {
        return text.replace(/[.\\/?&!#<>]/g, '').replace(/\s/g, '_');
      },
      ignoreSelector: ".toc-ignore",
      scrollTo: 0
    };
    options.showAndHide = true;
    options.smoothScroll = true;

    // tocify
    var toc = $("#TOC").tocify(options).data("toc-tocify");
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
